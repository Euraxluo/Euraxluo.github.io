---
layout:   post          
title:   05-12作业 
date:    2018-05-12      
author:   Euraxluo           
categories: java
tags:  线程
---
* TOC
{:toc}



#利用Socket、ServerSocket创建一个Client类和一个Server类，实现一个简易的聊天服务端

+ 代码

```java

##服务器：

import java.io.*;

import java.net.InetAddress;

import java.net.ServerSocket;

import java.net.Socket;

import java.util.Scanner;

import java.util.concurrent.ExecutorService;

import java.util.concurrent.Executors;



public class MyServerSocket {

    private ServerSocket server;

    private Socket socket;

    String host;

    public  int n = 0;

    ExecutorService pool = Executors.newFixedThreadPool(50);//创建一个最大容量为50的线程池，为每一个入站连接分配一条线程。



    public MyServerSocket() {

        try {

            server = new ServerSocket(233);/*指定端口*/

        } catch (Exception e) {

            System.out.println("端口被占用");

            System.exit(0);

        }

    }



    public void start() {

        try {

            System.out.println("等待客户端连接...");

            while (true) {

                socket = server.accept();//监听端口

                System.out.println("一个客户端连接成功！");

                //线程池中拿取一条线程来处理socket连接。然后主程序运行下一个循环，继续等待下一个客户端的访问。

                pool.execute(

                        new Runnable() {

                            @Override

                            public void run() {

                                GetClient(socket);

                                n++;

                            }}

                            );

                OutputToClient otc = new OutputToClient();

                new Thread(otc).run();

            }



        } catch (Exception e) {

            System.out.println("一个客户端连接失败！");

        }finally {

            pool.shutdownNow();

        }

    }



    public static void main(String[] args) {

        MyServerSocket server = new MyServerSocket();

        server.start();

    }

    static void GetClient(Socket socket){

        InetAddress host;

        host = socket.getInetAddress();

        Scanner put_in = new Scanner(System.in);

        try{

            InputStream input = socket.getInputStream();

            InputStreamReader isr = new InputStreamReader(input,"utf-8");

            BufferedReader in = new BufferedReader(isr);

            /*客户端信息流*/

            String message = null;

            boolean flag=true;

            while(((message=in.readLine())!=null )&&flag){

                boolean flg2 = message.endsWith("bye");

                System.out.println("["+host+"]说:"+message);

                if(flg2)

                {

                    flag=false;

                    System.out.println("客户断开连接！");

                }

            }

            in.close();

        }catch (Exception e){

            System.out.println("客户断开连接！");

        }finally {

            if(socket!=null){

                try{

                    socket.close();

                } catch (IOException e){

                    System.out.println("服务无法关闭！");

                }

            }

        }

    }

    private class OutputToClient implements Runnable{

        Scanner input = new Scanner(System.in);

        OutputStream out = socket.getOutputStream();

        OutputStreamWriter osw = new OutputStreamWriter(out,"utf-8");

        PrintWriter pw = new PrintWriter(osw,true);



        private OutputToClient() throws IOException {

            pw.println("欢迎客户连接！结束通话输入bye");

//            pw.println("线程运行次数："+n);

        }

        public void run(){

            while(true) {

                System.out.println("服务器输入：");

                String message = input.nextLine();

                pw.println(message);

            }

        }

    }

}



## 客户机：

import java.io.*;

import java.net.Socket;

import java.util.Scanner;



public class Client {

    public static Socket socket;

    /*初始化*/

    public Client() {

        try {

            /*

             * 服务器端口号

             * 服务器ip

             * */

            System.out.println("正在尝试连接服务器...");

            socket = new Socket("localhost", 233);

            System.out.println("与服务器连接成功");



        } catch (Exception e) {

            e.printStackTrace();

        }

    }



    public static void start(){

        try{

            /*启动接受消息的线程*/

            GetServerMesssge gsm = new GetServerMesssge();

            new Thread(gsm).start();

            /*利用getOutputStream方法获取输出*/

            Scanner input = new Scanner(System.in);

            OutputStream out = socket.getOutputStream();

            OutputStreamWriter osw = new OutputStreamWriter(out,"utf-8");

            PrintWriter pw = new PrintWriter(osw,true);

            while(true) {

                System.out.println("客户端输入：");

                String message = input.nextLine();

                pw.println(message);

            }

        }catch(Exception e) {

            e.printStackTrace();

        }

    }



    public static void main(String[] args){

        Client client = new Client();

        client.start();

    }



    private static class GetServerMesssge implements Runnable{

        public void run(){

            try{

                /*接受消息并输出*/

                InputStream in = socket.getInputStream();

                InputStreamReader isr = new InputStreamReader(in,"utf-8");

                BufferedReader buffer = new BufferedReader(isr);

                String message = null;

                while((message = buffer.readLine())!=null){

                    System.out.println("服务器:"+message);

                }

            }catch (Exception e)

            {

                e.printStackTrace();

            }

        }

    }

}

//本来想弄成多线程的。。

```
